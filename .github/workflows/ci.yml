name: CI for Training, Evaluation and Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-train-eval-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Install build tools
      - name: 🔧 Install  build tools
        run: sudo apt-get update && sudo apt-get install -y make

      # 3️⃣ Setup Python 3.10
      - name: 🛠️ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 4️⃣ Install dependencies using Makefile
      - name: 💾 Install Dependencies
        run: make install

      # 5️⃣ Train the model
      - name: 🏃 Train Model
        run: make train

      # 6️⃣ Evaluate the model
      - name: 📊 Evaluate Model
        run: make eval

      # 7️⃣ Display metrics in the log
      - name: 📝 Display Metrics
        run: cat result/metrics.txt || echo "Metrics file not found."

      # 8️⃣ Deploy to Hugging Face Space
      - name: 🚀 Deploy to Hugging Face Space
        env:
          HF: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Logging in to Hugging Face..."
          pip install -U "huggingface_hub[cli]"
          huggingface-cli login --token "$HF" --add-to-git-credential

          echo "Pushing app/model/results to Hugging Face Space..."
          make push-hub
