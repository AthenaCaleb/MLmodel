# 1. Add the name of the workflow.
name: CI for Training, Evaluation and Deployment

# 2. Trigger on push, PR, or manual run.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-train-eval-deploy:
    runs-on: ubuntu-latest

    steps:
      # 4. Checkout the repository
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      # Setup Python environment (essential for training)
      - name: 🛠️ Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      # 5. Install dependencies
      - name: 💾 Install Dependencies (using make)
        run: make install

      # 6. Train the model
      - name: 🏃 Train Model (using make)
        run: make train

      # 7. Evaluate the model
      - name: 📊 Evaluate Model (using make)
        run: make eval

      # Optional: Display metrics in the log
      - name: 📝 Display Metrics
        run: cat result/metrics.txt || echo "Metrics file not found."

      # 8. Hugging Face Deployment
      - name: 🚀 Deploy to Hugging Face Space
        env:
          HF: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Logging in to Hugging Face..."
          pip install -U "huggingface_hub[cli]"
          huggingface-cli login --token "$HF" --add-to-git-credential

          echo "Pushing updated app/model/results to Hugging Face Space..."
          make push-hub
