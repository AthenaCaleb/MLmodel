name: CI for Training, Evaluation and Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-train-eval-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install build tools
      - name: ğŸ”§ Install  build tools
        run: sudo apt-get update && sudo apt-get install -y make

      # 3ï¸âƒ£ Setup Python 3.10
      - name: ğŸ› ï¸ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 4ï¸âƒ£ Install dependencies using Makefile
      - name: ğŸ’¾ Install Dependencies
        run: make install

      # 5ï¸âƒ£ Train the model
      - name: ğŸƒ Train Model
        run: make train

      # 6ï¸âƒ£ Evaluate the model
      - name: ğŸ“Š Evaluate Model
        run: make eval

      # 7ï¸âƒ£ Display metrics in the log
      - name: ğŸ“ Display Metrics
        run: cat result/metrics.txt || echo "Metrics file not found."

      # 8ï¸âƒ£ Deploy to Hugging Face Space
      - name: ğŸš€ Deploy to Hugging Face Space
        env:
          HF: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Logging in to Hugging Face..."
          pip install -U "huggingface_hub[cli]"
          huggingface-cli login --token "$HF" --add-to-git-credential

          echo "Pushing app/model/results to Hugging Face Space..."
          make push-hub
