# =============================
# Workflow: CI for Training, Evaluation and Deployment
# =============================
name: CI for Training, Evaluation and Deployment

# Trigger on push, PR, or manual run
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-train-eval-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Install build tools (make)
      - name: 🔧 Install build tools
        run: sudo apt-get update && sudo apt-get install -y make build-essential

      # 3️⃣ Setup Python 3.11
      - name: 🛠️ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 4️⃣ Upgrade pip, setuptools, wheel
      - name: ⚡ Upgrade pip, setuptools, wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      # 5️⃣ Install dependencies using Makefile
      - name: 💾 Install Dependencies (Makefile)
        run: make install

      # 6️⃣ Train the model
      - name: 🏃 Train Model
        run: make train

      # 7️⃣ Evaluate the model
      - name: 📊 Evaluate Model
        run: make eval

      # 8️⃣ Display metrics in the log (optional)
      - name: 📝 Display Metrics
        run: cat result/metrics.txt || echo "Metrics file not found."

      # 9️⃣ Hugging Face Deployment
      - name: 🚀 Deploy to Hugging Face Space
        env:
          HF: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Logging in to Hugging Face..."
          pip install -U "huggingface_hub[cli]"
          huggingface-cli login --token "$HF" --add-to-git-credential

          echo "Pushing updated app/model/results to Hugging Face Space..."
          make push-hub
