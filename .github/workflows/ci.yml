# =============================
# Workflow: CI for Training, Evaluation and Deployment
# =============================
name: CI for Training, Evaluation and Deployment

# Trigger on push, PR, or manual run
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-train-eval-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install build tools (make)
      - name: ğŸ”§ Install build tools
        run: sudo apt-get update && sudo apt-get install -y make build-essential

      # 3ï¸âƒ£ Setup Python 3.11
      - name: ğŸ› ï¸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 4ï¸âƒ£ Upgrade pip, setuptools, wheel
      - name: âš¡ Upgrade pip, setuptools, wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      # 5ï¸âƒ£ Install dependencies using Makefile
      - name: ğŸ’¾ Install Dependencies (Makefile)
        run: make install

      # 6ï¸âƒ£ Train the model
      - name: ğŸƒ Train Model
        run: make train

      # 7ï¸âƒ£ Evaluate the model
      - name: ğŸ“Š Evaluate Model
        run: make eval

      # 8ï¸âƒ£ Display metrics in the log (optional)
      - name: ğŸ“ Display Metrics
        run: cat result/metrics.txt || echo "Metrics file not found."

      # 9ï¸âƒ£ Hugging Face Deployment
      - name: ğŸš€ Deploy to Hugging Face Space
        env:
          HF: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Logging in to Hugging Face..."
          pip install -U "huggingface_hub[cli]"
          huggingface-cli login --token "$HF" --add-to-git-credential

          echo "Pushing updated app/model/results to Hugging Face Space..."
          make push-hub
